<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zombicide Weapon Manager</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    :root {
      --bg1: #ff6b6b;
      --bg2: #6bafff;
      --bg3: #51ffae;
      --bg4: #ffc36b;
      --melee: #51ffae;
      --ranged: #6bafff;
      --zombie: #ff6b6b;
      --bonus: #ffc36b;
      --dual: #a06bff;
      --card-bg: rgba(255, 255, 255, 0.95);
      --card-shadow: rgba(0, 0, 0, 0.15);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(270deg, var(--bg1), var(--bg2), var(--bg3), var(--bg4));
      background-size: 800% 800%;
      animation: gradientShift 20s ease infinite;
      min-height: 100vh;
      color: #333;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    header h1 {
      font-size: 2.5rem;
      margin: 0 0 10px 0;
      letter-spacing: 2px;
    }

    header p {
      font-size: 1.1rem;
      opacity: 0.95;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 8px 32px var(--card-shadow);
      backdrop-filter: blur(10px);
    }

    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .controls button, .controls label {
      background: white;
      border: 2px solid #ddd;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.3s;
      color: #333;
      height: 48px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .controls button:hover, .controls label:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-color: var(--bg2);
    }

    .controls input[type="file"] {
      display: none;
    }

    .search-filter {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .search-filter {
        grid-template-columns: 1fr;
      }
    }

    input, select, textarea {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: border-color 0.3s;
      line-height: 1.5;
    }

    input[type="text"],
    input[type="number"],
    select {
      height: 44px;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--bg2);
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-section {
      margin-bottom: 25px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 12px;
    }

    .form-section h3 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 1.1rem;
      border-bottom: 2px solid #ddd;
      padding-bottom: 8px;
    }

    .hidden {
      display: none !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--bg2), var(--bg3));
      border: none;
      color: white;
      padding: 15px 35px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .weapons-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .weapon-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .weapon-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .weapon-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, var(--category-color), transparent);
    }

    .weapon-card.category-melee::before { --category-color: var(--melee); }
    .weapon-card.category-ranged::before { --category-color: var(--ranged); }
    .weapon-card.category-zombie::before { --category-color: var(--zombie); }
    .weapon-card.category-bonus::before { --category-color: var(--bonus); }
    .weapon-card.category-dual::before { --category-color: var(--dual); }

    .weapon-header {
      margin-bottom: 12px;
    }

    .weapon-title-row {
      margin-bottom: 10px;
    }

    .weapon-name {
      font-size: 1.3rem;
      font-weight: 700;
      color: #222;
      margin: 0 0 10px 0;
    }

    .weapon-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .category-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      color: white;
    }

    .category-badge.melee { background: var(--melee); }
    .category-badge.ranged { background: var(--ranged); }
    .category-badge.zombie { background: var(--zombie); }
    .category-badge.bonus { background: var(--bonus); }
    .category-badge.dual { background: var(--dual); }

    .count-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      background: #6c757d;
      color: white;
    }

    .weapon-pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .pill {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      background: #e9ecef;
      color: #495057;
    }

    .weapon-stats {
      margin-bottom: 15px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.9rem;
    }

    .stat-label {
      color: #666;
      font-weight: 600;
    }

    .stat-value {
      color: #333;
      font-weight: 700;
    }

    .weapon-special {
      background: #fff8e1;
      padding: 10px;
      border-radius: 6px;
      border-left: 4px solid var(--bg4);
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 15px;
    }

    .weapon-actions {
      display: flex;
      gap: 10px;
    }

    .btn-edit, .btn-delete {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-edit {
      background: var(--bg2);
      color: white;
    }

    .btn-delete {
      background: var(--zombie);
      color: white;
    }

    .btn-edit:hover, .btn-delete:hover {
      transform: scale(1.05);
      opacity: 0.9;
    }

    .checkbox-group {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 10px;
    }

    #editingBanner {
      background: var(--bg4);
      color: white;
      padding: 12px;
      text-align: center;
      font-weight: 600;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .form-actions {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn-secondary {
      background: #6c757d;
      border: none;
      color: white;
      padding: 15px 35px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .stats-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .stats-row input {
      flex: 1;
    }

    @media (max-width: 768px) {
      .weapons-grid {
        grid-template-columns: 1fr;
      }

      header h1 {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>‚öîÔ∏è ZOMBICIDE WEAPON MANAGER</h1>
      <p>Add, edit, and manage your Zombicide weapons collection</p>
    </header>

    <div class="card">
      <div class="controls">
        <label for="importXML">
          üìÅ Import XML
          <input type="file" id="importXML" accept=".xml">
        </label>
        <button onclick="downloadXML()">üíæ Download XML</button>
        <button onclick="clearAll()">üóëÔ∏è Clear All</button>
      </div>
    </div>

    <div class="card">
      <div id="editingBanner" class="hidden">
        ‚úèÔ∏è Editing Weapon - Make changes below and click Update
      </div>

      <h2>Add New Weapon</h2>
      <form id="weaponForm" onsubmit="return handleSubmit(event)">
        <div class="form-section">
          <h3>Basic Information</h3>
          <div class="form-grid">
            <div>
              <label for="name">Name *</label>
              <input type="text" id="name" required>
            </div>
            <div>
              <label for="set">Set *</label>
              <input type="text" id="set" required>
            </div>
            <div>
              <label for="deck">Deck *</label>
              <input type="text" id="deck" required>
            </div>
            <div>
              <label for="count">Count *</label>
              <input type="number" id="count" required min="0">
            </div>
            <div>
              <label for="category">Category *</label>
              <select id="category" required onchange="updateFormSections()">
                <option value="">Select...</option>
                <option value="Melee">Melee</option>
                <option value="Ranged">Ranged</option>
                <option value="Dual">Dual (Melee + Ranged)</option>
                <option value="Zombie">Zombie</option>
                <option value="Bonus">Bonus</option>
              </select>
            </div>
          </div>
        </div>

        <div id="meleeSection" class="form-section hidden">
          <h3>Melee Stats</h3>
          <div class="form-grid">
            <div>
              <label for="meleeRange">Range</label>
              <input type="number" id="meleeRange" min="0">
            </div>
            <div>
              <label for="meleeDice">Dice</label>
              <input type="number" id="meleeDice" min="0">
            </div>
            <div>
              <label for="meleeAccuracy">Accuracy</label>
              <input type="number" id="meleeAccuracy" min="0">
            </div>
            <div>
              <label for="meleeDamage">Damage</label>
              <input type="number" id="meleeDamage" min="0">
            </div>
            <div>
              <label for="meleeOverload">Overload</label>
              <input type="number" id="meleeOverload" min="0">
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="meleeKillNoise">
              <label for="meleeKillNoise">Kill Noise</label>
            </div>
          </div>
        </div>

        <div id="rangedSection" class="form-section hidden">
          <h3>Ranged Stats</h3>
          <div class="form-grid">
            <div>
              <label for="rangedAmmoType">Ammo Type</label>
              <input type="text" id="rangedAmmoType" placeholder="e.g., Bullets, Shells">
            </div>
            <div>
              <label for="rangedRangeMin">Range Min</label>
              <input type="number" id="rangedRangeMin" min="0">
            </div>
            <div>
              <label for="rangedRangeMax">Range Max</label>
              <input type="number" id="rangedRangeMax" min="0">
            </div>
            <div>
              <label for="rangedDice">Dice</label>
              <input type="number" id="rangedDice" min="0">
            </div>
            <div>
              <label for="rangedAccuracy">Accuracy</label>
              <input type="number" id="rangedAccuracy" min="0">
            </div>
            <div>
              <label for="rangedDamage">Damage</label>
              <input type="number" id="rangedDamage" min="0">
            </div>
            <div>
              <label for="rangedOverload">Overload</label>
              <input type="number" id="rangedOverload" min="0">
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="rangedKillNoise">
              <label for="rangedKillNoise">Kill Noise</label>
            </div>
          </div>
        </div>

        <div id="commonSection" class="form-section hidden">
          <h3>Additional Properties</h3>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="openDoor">
              <label for="openDoor">Open Door</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="doorNoise">
              <label for="doorNoise">Door Noise</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="dual">
              <label for="dual">Dual Wield</label>
            </div>
          </div>
          <div style="margin-top: 20px;">
            <label for="special">Special Ability</label>
            <textarea id="special" rows="3" placeholder="Enter special abilities or notes..."></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="cancelEdit()" id="cancelBtn" style="display: none;">Cancel</button>
          <button type="submit" class="btn-primary" id="submitBtn">Add Weapon</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2>Weapon Collection</h2>
      <div class="search-filter">
        <div>
          <label for="searchName">Search by Name</label>
          <input type="text" id="searchName" placeholder="Search..." onkeyup="filterWeapons()">
        </div>
        <div>
          <label for="filterSet">Filter by Set</label>
          <select id="filterSet" onchange="filterWeapons()">
            <option value="">All Sets</option>
          </select>
        </div>
        <div>
          <label for="filterDeck">Filter by Deck</label>
          <select id="filterDeck" onchange="filterWeapons()">
            <option value="">All Decks</option>
          </select>
        </div>
        <div>
          <label for="filterCategory">Filter by Category</label>
          <select id="filterCategory" onchange="filterWeapons()">
            <option value="">All Categories</option>
            <option value="Melee">Melee</option>
            <option value="Ranged">Ranged</option>
            <option value="Dual">Dual</option>
            <option value="Zombie">Zombie</option>
            <option value="Bonus">Bonus</option>
          </select>
        </div>
      </div>
      <div id="weaponsContainer" class="weapons-grid"></div>
    </div>
  </div>

  <script>
    let weapons = [];
    let editingIndex = -1;

    // Load from localStorage on startup
    window.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('zombicideWeapons');
      if (saved) {
        weapons = JSON.parse(saved);
        renderWeapons();
        updateFilterOptions();
      }
    });

    function updateFormSections() {
      const category = document.getElementById('category').value;
      const meleeSection = document.getElementById('meleeSection');
      const rangedSection = document.getElementById('rangedSection');
      const commonSection = document.getElementById('commonSection');

      meleeSection.classList.add('hidden');
      rangedSection.classList.add('hidden');
      commonSection.classList.add('hidden');

      if (category === 'Melee') {
        meleeSection.classList.remove('hidden');
        commonSection.classList.remove('hidden');
      } else if (category === 'Ranged') {
        rangedSection.classList.remove('hidden');
        commonSection.classList.remove('hidden');
      } else if (category === 'Dual') {
        meleeSection.classList.remove('hidden');
        rangedSection.classList.remove('hidden');
        commonSection.classList.remove('hidden');
      } else if (category === 'Zombie' || category === 'Bonus') {
        commonSection.classList.remove('hidden');
      }
    }

    function handleSubmit(event) {
      event.preventDefault();

      const weapon = {
        name: document.getElementById('name').value,
        set: document.getElementById('set').value,
        deck: document.getElementById('deck').value,
        count: parseInt(document.getElementById('count').value),
        category: document.getElementById('category').value,
      };

      const category = weapon.category;

      // Add melee stats if applicable
      if (category === 'Melee' || category === 'Dual') {
        weapon.melee = {
          range: document.getElementById('meleeRange').value || '',
          dice: document.getElementById('meleeDice').value || '',
          accuracy: document.getElementById('meleeAccuracy').value || '',
          damage: document.getElementById('meleeDamage').value || '',
          overload: document.getElementById('meleeOverload').value || '',
          killNoise: document.getElementById('meleeKillNoise').checked
        };
      }

      // Add ranged stats if applicable
      if (category === 'Ranged' || category === 'Dual') {
        weapon.ranged = {
          ammoType: document.getElementById('rangedAmmoType').value || '',
          rangeMin: document.getElementById('rangedRangeMin').value || '',
          rangeMax: document.getElementById('rangedRangeMax').value || '',
          dice: document.getElementById('rangedDice').value || '',
          accuracy: document.getElementById('rangedAccuracy').value || '',
          damage: document.getElementById('rangedDamage').value || '',
          overload: document.getElementById('rangedOverload').value || '',
          killNoise: document.getElementById('rangedKillNoise').checked
        };
      }

      // Add common properties
      if (category !== 'Zombie' && category !== 'Bonus') {
        weapon.openDoor = document.getElementById('openDoor').checked;
        weapon.doorNoise = document.getElementById('doorNoise').checked;
        weapon.dual = document.getElementById('dual').checked;
      }

      weapon.special = document.getElementById('special').value || '';

      if (editingIndex >= 0) {
        weapons[editingIndex] = weapon;
        editingIndex = -1;
        document.getElementById('editingBanner').classList.add('hidden');
        document.getElementById('cancelBtn').style.display = 'none';
        document.getElementById('submitBtn').textContent = 'Add Weapon';
      } else {
        weapons.push(weapon);
      }

      saveToStorage();
      renderWeapons();
      updateFilterOptions();
      document.getElementById('weaponForm').reset();
      updateFormSections();

      return false;
    }

    function saveToStorage() {
      localStorage.setItem('zombicideWeapons', JSON.stringify(weapons));
    }

    function renderWeapons() {
      const container = document.getElementById('weaponsContainer');

      if (weapons.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No weapons yet</h3>
            <p>Add your first weapon using the form above or import an XML file</p>
          </div>
        `;
        return;
      }

      container.innerHTML = weapons.map((weapon, index) => {
        const categoryClass = weapon.category.toLowerCase();
        let statsHTML = '';

        if (weapon.melee) {
          const m = weapon.melee;
          statsHTML += `
            <div class="weapon-stats">
              <div style="font-weight: 700; margin-bottom: 8px; color: var(--melee);">‚öîÔ∏è Melee</div>
              ${m.dice ? `<div class="stat-row"><span class="stat-label">Dice:</span><span class="stat-value">${m.dice}</span></div>` : ''}
              ${m.accuracy ? `<div class="stat-row"><span class="stat-label">Accuracy:</span><span class="stat-value">${m.accuracy}+</span></div>` : ''}
              ${m.damage ? `<div class="stat-row"><span class="stat-label">Damage:</span><span class="stat-value">${m.damage}</span></div>` : ''}
              ${m.overload ? `<div class="stat-row"><span class="stat-label">Overload:</span><span class="stat-value">${m.overload}</span></div>` : ''}
              ${m.killNoise ? `<div class="stat-row"><span class="stat-label">Kill Noise:</span><span class="stat-value">Yes</span></div>` : ''}
            </div>
          `;
        }

        if (weapon.ranged) {
          const r = weapon.ranged;
          statsHTML += `
            <div class="weapon-stats">
              <div style="font-weight: 700; margin-bottom: 8px; color: var(--ranged);">üéØ Ranged</div>
              ${r.ammoType ? `<div class="stat-row"><span class="stat-label">Ammo:</span><span class="stat-value">${r.ammoType}</span></div>` : ''}
              ${r.rangeMin || r.rangeMax ? `<div class="stat-row"><span class="stat-label">Range:</span><span class="stat-value">${r.rangeMin || 0}-${r.rangeMax || 0}</span></div>` : ''}
              ${r.dice ? `<div class="stat-row"><span class="stat-label">Dice:</span><span class="stat-value">${r.dice}</span></div>` : ''}
              ${r.accuracy ? `<div class="stat-row"><span class="stat-label">Accuracy:</span><span class="stat-value">${r.accuracy}+</span></div>` : ''}
              ${r.damage ? `<div class="stat-row"><span class="stat-label">Damage:</span><span class="stat-value">${r.damage}</span></div>` : ''}
              ${r.overload ? `<div class="stat-row"><span class="stat-label">Overload:</span><span class="stat-value">${r.overload}</span></div>` : ''}
              ${r.killNoise ? `<div class="stat-row"><span class="stat-label">Kill Noise:</span><span class="stat-value">Yes</span></div>` : ''}
            </div>
          `;
        }

        return `
          <div class="weapon-card category-${categoryClass}" data-index="${index}">
            <div class="weapon-header">
              <div class="weapon-title-row">
                <h3 class="weapon-name">${weapon.name}</h3>
              </div>
              <div class="weapon-pills">
                <span class="pill">${weapon.set}</span>
                <span class="pill">${weapon.deck}</span>
              </div>
              <div class="weapon-meta-row">
                <span class="category-badge ${categoryClass}">${weapon.category}</span>
                <span class="count-badge">Count: ${weapon.count}</span>
              </div>
            </div>
            ${statsHTML}
            ${weapon.special ? `<div class="weapon-special"><strong>Special:</strong> ${weapon.special}</div>` : ''}
            <div class="weapon-actions">
              <button class="btn-edit" onclick="editWeapon(${index})">Edit</button>
              <button class="btn-delete" onclick="deleteWeapon(${index})">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function editWeapon(index) {
      editingIndex = index;
      const weapon = weapons[index];

      document.getElementById('name').value = weapon.name;
      document.getElementById('set').value = weapon.set;
      document.getElementById('deck').value = weapon.deck;
      document.getElementById('count').value = weapon.count;
      document.getElementById('category').value = weapon.category;

      updateFormSections();

      if (weapon.melee) {
        document.getElementById('meleeRange').value = weapon.melee.range || '';
        document.getElementById('meleeDice').value = weapon.melee.dice || '';
        document.getElementById('meleeAccuracy').value = weapon.melee.accuracy || '';
        document.getElementById('meleeDamage').value = weapon.melee.damage || '';
        document.getElementById('meleeOverload').value = weapon.melee.overload || '';
        document.getElementById('meleeKillNoise').checked = weapon.melee.killNoise || false;
      }

      if (weapon.ranged) {
        document.getElementById('rangedAmmoType').value = weapon.ranged.ammoType || '';
        document.getElementById('rangedRangeMin').value = weapon.ranged.rangeMin || '';
        document.getElementById('rangedRangeMax').value = weapon.ranged.rangeMax || '';
        document.getElementById('rangedDice').value = weapon.ranged.dice || '';
        document.getElementById('rangedAccuracy').value = weapon.ranged.accuracy || '';
        document.getElementById('rangedDamage').value = weapon.ranged.damage || '';
        document.getElementById('rangedOverload').value = weapon.ranged.overload || '';
        document.getElementById('rangedKillNoise').checked = weapon.ranged.killNoise || false;
      }

      document.getElementById('openDoor').checked = weapon.openDoor || false;
      document.getElementById('doorNoise').checked = weapon.doorNoise || false;
      document.getElementById('dual').checked = weapon.dual || false;
      document.getElementById('special').value = weapon.special || '';

      document.getElementById('editingBanner').classList.remove('hidden');
      document.getElementById('cancelBtn').style.display = 'inline-block';
      document.getElementById('submitBtn').textContent = 'Update Weapon';

      window.scrollTo({ top: 0, behavior: 'smooth' });

      // Focus the name field after a brief delay to ensure scroll completes
      setTimeout(() => {
        document.getElementById('name').focus();
      }, 300);
    }

    function cancelEdit() {
      editingIndex = -1;
      document.getElementById('weaponForm').reset();
      document.getElementById('editingBanner').classList.add('hidden');
      document.getElementById('cancelBtn').style.display = 'none';
      document.getElementById('submitBtn').textContent = 'Add Weapon';
      updateFormSections();
    }

    function deleteWeapon(index) {
      if (confirm(`Delete "${weapons[index].name}"?`)) {
        weapons.splice(index, 1);
        saveToStorage();
        renderWeapons();
        updateFilterOptions();
      }
    }

    function clearAll() {
      if (confirm('Clear all weapons? This cannot be undone!')) {
        weapons = [];
        saveToStorage();
        renderWeapons();
        updateFilterOptions();
      }
    }

    function updateFilterOptions() {
      const sets = [...new Set(weapons.map(w => w.set))].sort();
      const decks = [...new Set(weapons.map(w => w.deck))].sort();

      const setSelect = document.getElementById('filterSet');
      const deckSelect = document.getElementById('filterDeck');

      setSelect.innerHTML = '<option value="">All Sets</option>' +
        sets.map(s => `<option value="${s}">${s}</option>`).join('');

      deckSelect.innerHTML = '<option value="">All Decks</option>' +
        decks.map(d => `<option value="${d}">${d}</option>`).join('');
    }

    function filterWeapons() {
      const searchName = document.getElementById('searchName').value.toLowerCase();
      const filterSet = document.getElementById('filterSet').value;
      const filterDeck = document.getElementById('filterDeck').value;
      const filterCategory = document.getElementById('filterCategory').value;

      const cards = document.querySelectorAll('.weapon-card');

      cards.forEach((card, index) => {
        const weapon = weapons[index];

        const matchesName = weapon.name.toLowerCase().includes(searchName);
        const matchesSet = !filterSet || weapon.set === filterSet;
        const matchesDeck = !filterDeck || weapon.deck === filterDeck;
        const matchesCategory = !filterCategory || weapon.category === filterCategory;

        if (matchesName && matchesSet && matchesDeck && matchesCategory) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    }

    // XML Import
    document.getElementById('importXML').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(e.target.result, 'text/xml');

          const weaponNodes = xmlDoc.getElementsByTagName('Weapon');
          weapons = [];

          for (let node of weaponNodes) {
            const weapon = {
              name: getXMLValue(node, 'Name'),
              set: getXMLValue(node, 'Set'),
              deck: getXMLValue(node, 'Deck'),
              count: parseInt(getXMLValue(node, 'Count')),
              category: getXMLValue(node, 'Category'),
            };

            const meleeNode = node.getElementsByTagName('Melee')[0];
            if (meleeNode && meleeNode.children.length > 0) {
              weapon.melee = {
                range: getXMLValue(meleeNode, 'Range'),
                dice: getXMLValue(meleeNode, 'Dice'),
                accuracy: getXMLValue(meleeNode, 'Accuracy'),
                damage: getXMLValue(meleeNode, 'Damage'),
                overload: getXMLValue(meleeNode, 'Overload'),
                killNoise: getXMLValue(meleeNode, 'Kill_Noise') === 'true'
              };
            }

            const rangedNode = node.getElementsByTagName('Ranged')[0];
            if (rangedNode && rangedNode.children.length > 0) {
              weapon.ranged = {
                ammoType: getXMLValue(rangedNode, 'Ammo_Type'),
                rangeMin: getXMLValue(rangedNode, 'Range_Min'),
                rangeMax: getXMLValue(rangedNode, 'Range_Max'),
                dice: getXMLValue(rangedNode, 'Dice'),
                accuracy: getXMLValue(rangedNode, 'Accuracy'),
                damage: getXMLValue(rangedNode, 'Damage'),
                overload: getXMLValue(rangedNode, 'Overload'),
                killNoise: getXMLValue(rangedNode, 'Kill_Noise') === 'true'
              };
            }

            weapon.openDoor = getXMLValue(node, 'Open_Door') === 'true';
            weapon.doorNoise = getXMLValue(node, 'Door_Noise') === 'true';
            weapon.dual = getXMLValue(node, 'Dual') === 'true';
            weapon.special = getXMLValue(node, 'Special');

            weapons.push(weapon);
          }

          saveToStorage();
          renderWeapons();
          updateFilterOptions();
          alert(`Successfully imported ${weapons.length} weapons!`);
        } catch (error) {
          alert('Error parsing XML file: ' + error.message);
        }
      };
      reader.readAsText(file);
    });

    function getXMLValue(node, tagName) {
      const element = node.getElementsByTagName(tagName)[0];
      return element ? element.textContent : '';
    }

    // XML Export
    function downloadXML() {
      if (weapons.length === 0) {
        alert('No weapons to export!');
        return;
      }

      let xml = '<?xml version=\'1.0\' encoding=\'utf-8\'?>\n';
      xml += '<Weapons xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="weapons.xsd">\n';

      weapons.forEach(weapon => {
        xml += '  <Weapon>\n';
        xml += `    <Name>${escapeXML(weapon.name)}</Name>\n`;
        xml += `    <Set>${escapeXML(weapon.set)}</Set>\n`;
        xml += `    <Deck>${escapeXML(weapon.deck)}</Deck>\n`;
        xml += `    <Count>${weapon.count}</Count>\n`;
        xml += `    <Category>${escapeXML(weapon.category)}</Category>\n`;

        if (weapon.melee) {
          xml += '    <Melee>\n';
          if (weapon.melee.range) xml += `      <Range>${weapon.melee.range}</Range>\n`;
          if (weapon.melee.dice) xml += `      <Dice>${weapon.melee.dice}</Dice>\n`;
          if (weapon.melee.accuracy) xml += `      <Accuracy>${weapon.melee.accuracy}</Accuracy>\n`;
          if (weapon.melee.damage) xml += `      <Damage>${weapon.melee.damage}</Damage>\n`;
          if (weapon.melee.overload) xml += `      <Overload>${weapon.melee.overload}</Overload>\n`;
          if (weapon.melee.killNoise !== undefined) xml += `      <Kill_Noise>${weapon.melee.killNoise}</Kill_Noise>\n`;
          xml += '    </Melee>\n';
        } else {
          xml += '    <Melee />\n';
        }

        if (weapon.ranged) {
          xml += '    <Ranged>\n';
          if (weapon.ranged.ammoType) xml += `      <Ammo_Type>${escapeXML(weapon.ranged.ammoType)}</Ammo_Type>\n`;
          if (weapon.ranged.rangeMin) xml += `      <Range_Min>${weapon.ranged.rangeMin}</Range_Min>\n`;
          if (weapon.ranged.rangeMax) xml += `      <Range_Max>${weapon.ranged.rangeMax}</Range_Max>\n`;
          if (weapon.ranged.dice) xml += `      <Dice>${weapon.ranged.dice}</Dice>\n`;
          if (weapon.ranged.accuracy) xml += `      <Accuracy>${weapon.ranged.accuracy}</Accuracy>\n`;
          if (weapon.ranged.damage) xml += `      <Damage>${weapon.ranged.damage}</Damage>\n`;
          if (weapon.ranged.overload) xml += `      <Overload>${weapon.ranged.overload}</Overload>\n`;
          if (weapon.ranged.killNoise !== undefined) xml += `      <Kill_Noise>${weapon.ranged.killNoise}</Kill_Noise>\n`;
          xml += '    </Ranged>\n';
        } else {
          xml += '    <Ranged />\n';
        }

        if (weapon.openDoor !== undefined) xml += `    <Open_Door>${weapon.openDoor}</Open_Door>\n`;
        if (weapon.doorNoise !== undefined) xml += `    <Door_Noise>${weapon.doorNoise}</Door_Noise>\n`;
        if (weapon.dual !== undefined) xml += `    <Dual>${weapon.dual}</Dual>\n`;

        if (weapon.special) {
          xml += `    <Special>${escapeXML(weapon.special)}</Special>\n`;
        } else {
          xml += '    <Special />\n';
        }

        xml += '  </Weapon>\n';
      });

      xml += '</Weapons>\n';

      const blob = new Blob([xml], { type: 'application/xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'weapons.xml';
      a.click();
      URL.revokeObjectURL(url);
    }

    function escapeXML(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&apos;');
    }
  </script>
</body>
</html>
